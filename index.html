<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker Attendance Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px;
            text-align: center;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .search-container {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-box {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
        }

        .search-box:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .worker-card {
            margin: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .worker-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .worker-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .worker-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .calendar-container {
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: #4facfe;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #667eea;
            transform: scale(1.1);
        }

        .month-year {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .calendar-header-cell {
            background: #495057;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .calendar-cell {
            background: white;
            min-height: 40px;
            padding: 4px 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-cell:hover {
            background: #f8f9fa;
        }

        .calendar-cell.other-month {
            background: #f8f9fa;
            color: #adb5bd;
        }

        .calendar-cell.today {
            background: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .date-number {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }

        .attendance-badge {
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: bold;
            text-align: center;
            min-width: 20px;
        }

        .present {
            background: #d4edda;
            color: #155724;
        }

        .absent {
            background: #f8d7da;
            color: #721c24;
        }

        .overtime {
            background: #fff3cd;
            color: #856404;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #f8d7da;
            margin: 20px;
            border-radius: 10px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .worker-list {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .worker-suggestion {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .worker-suggestion:hover {
            background: #e9ecef;
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .worker-suggestion-name {
            font-weight: bold;
            color: #333;
        }

        .worker-suggestion-count {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .calendar-cell {
                min-height: 35px;
                padding: 2px 1px;
            }
            
            .date-number {
                font-size: 0.75rem;
            }
            
            .attendance-badge {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
            
            .month-year {
                font-size: 1.1rem;
            }
            
            .nav-btn {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .calendar-header-cell {
                padding: 6px 2px;
                font-size: 0.75rem;
            }
            
            .calendar-cell {
                min-height: 30px;
            }
            
            .worker-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Worker Attendance Dashboard</h1>
            <p>Search for a worker to view their attendance calendar</p>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-box" id="searchInput" placeholder="üîç Search worker name..." autocomplete="off">
        </div>
        
        <div id="content">
            <div class="loading">
                <div style="font-size: 2rem; margin-bottom: 10px;">‚è≥</div>
                Loading worker data...
            </div>
        </div>
    </div>

    <script>
        class AttendanceDashboard {
            constructor() {
                this.csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?gid=1025965600&single=true&output=csv';
                this.attendanceData = [];
                this.workerNames = [];
                this.currentWorker = null;
                this.currentDate = new Date();
                
                this.init();
            }

            async init() {
                try {
                    await this.loadData();
                    this.setupEventListeners();
                    this.showWorkerList();
                } catch (error) {
                    this.showError('Failed to load attendance data. Please check your internet connection and try again.');
                    console.error('Initialization error:', error);
                }
            }

            async loadData() {
                try {
                    const response = await fetch(this.csvUrl + '&_=' + Date.now());
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    this.parseCSV(csvText);
                } catch (error) {
                    console.error('Error loading data:', error);
                    throw error;
                }
            }

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) {
                    throw new Error('Invalid CSV format');
                }

                // Skip header row
                const dataLines = lines.slice(1);
                this.attendanceData = [];
                const workerSet = new Set();

                dataLines.forEach((line, index) => {
                    try {
                        // Handle CSV parsing with potential commas in quoted fields
                        const fields = this.parseCSVLine(line);
                        
                        if (fields.length >= 7) {
                            const record = {
                                date: this.parseDate(fields[0]),
                                supervisor: fields[1]?.trim() || '',
                                workerName: fields[2]?.trim() || '',
                                totalManhours: parseFloat(fields[3]) || 0,
                                otHours: parseFloat(fields[4]) || 0,
                                endShiftHours: parseFloat(fields[5]) || 0,
                                manhours: parseFloat(fields[6]) || 0
                            };

                            if (record.workerName && record.date) {
                                this.attendanceData.push(record);
                                workerSet.add(record.workerName);
                            }
                        }
                    } catch (error) {
                        console.warn(`Error parsing line ${index + 2}:`, error);
                    }
                });

                this.workerNames = Array.from(workerSet).sort();
                console.log(`Loaded ${this.attendanceData.length} attendance records for ${this.workerNames.length} workers`);
            }

            parseCSVLine(line) {
                const fields = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        fields.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                fields.push(current);
                return fields;
            }

            parseDate(dateStr) {
                if (!dateStr) return null;
                
                // Try different date formats
                const cleanDate = dateStr.trim().replace(/"/g, '');
                
                // MM/DD/YYYY or M/D/YYYY
                const mmddyyyy = cleanDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (mmddyyyy) {
                    return new Date(mmddyyyy[3], mmddyyyy[1] - 1, mmddyyyy[2]);
                }
                
                // DD/MM/YYYY or D/M/YYYY
                const ddmmyyyy = cleanDate.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
                if (ddmmyyyy) {
                    // Assume MM/DD/YYYY format first
                    const date = new Date(ddmmyyyy[3], ddmmyyyy[1] - 1, ddmmyyyy[2]);
                    if (date.getMonth() === parseInt(ddmmyyyy[1]) - 1) {
                        return date;
                    }
                }
                
                // Try parsing as is
                const parsed = new Date(cleanDate);
                return isNaN(parsed.getTime()) ? null : parsed;
            }

            setupEventListeners() {
                const searchInput = document.getElementById('searchInput');
                let searchTimeout;

                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const query = e.target.value.trim();
                        if (query.length === 0) {
                            this.showWorkerList();
                        } else if (query.length >= 2) {
                            this.searchWorker(query);
                        }
                    }, 300);
                });

                // Refresh data every 5 minutes
                setInterval(() => {
                    this.loadData().catch(console.error);
                }, 5 * 60 * 1000);
            }

            showWorkerList() {
                const content = document.getElementById('content');
                const workerCounts = {};
                
                // Count attendance records per worker
                this.attendanceData.forEach(record => {
                    workerCounts[record.workerName] = (workerCounts[record.workerName] || 0) + 1;
                });

                content.innerHTML = `
                    <div class="worker-list">
                        ${this.workerNames.map(name => `
                            <div class="worker-suggestion" onclick="dashboard.selectWorker('${name}')">
                                <div class="worker-suggestion-name">${name}</div>
                                <div class="worker-suggestion-count">${workerCounts[name] || 0} attendance records</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            searchWorker(query) {
                const matches = this.workerNames.filter(name => 
                    name.toLowerCase().includes(query.toLowerCase())
                );

                if (matches.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="no-results">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üë§</div>
                            <h3>No worker found</h3>
                            <p>No worker found with name containing "${query}"</p>
                        </div>
                    `;
                } else if (matches.length === 1) {
                    this.selectWorker(matches[0]);
                } else {
                    const workerCounts = {};
                    this.attendanceData.forEach(record => {
                        workerCounts[record.workerName] = (workerCounts[record.workerName] || 0) + 1;
                    });

                    document.getElementById('content').innerHTML = `
                        <div class="worker-list">
                            ${matches.map(name => `
                                <div class="worker-suggestion" onclick="dashboard.selectWorker('${name}')">
                                    <div class="worker-suggestion-name">${name}</div>
                                    <div class="worker-suggestion-count">${workerCounts[name] || 0} attendance records</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            selectWorker(workerName) {
                this.currentWorker = workerName;
                document.getElementById('searchInput').value = workerName;
                this.showWorkerCard();
            }

            showWorkerCard() {
                if (!this.currentWorker) return;

                const workerData = this.attendanceData.filter(record => 
                    record.workerName === this.currentWorker
                );

                if (workerData.length === 0) {
                    document.getElementById('content').innerHTML = `
                        <div class="no-results">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üìã</div>
                            <h3>No attendance data</h3>
                            <p>No attendance records found for ${this.currentWorker}</p>
                        </div>
                    `;
                    return;
                }

                // Calculate statistics
                const totalDays = workerData.length;
                const totalOT = workerData.reduce((sum, record) => sum + record.otHours, 0);
                const totalManhours = workerData.reduce((sum, record) => sum + record.totalManhours, 0);
                const avgHours = totalManhours / totalDays;

                document.getElementById('content').innerHTML = `
                    <div class="worker-card">
                        <div class="worker-header">
                            <div class="worker-name">${this.currentWorker}</div>
                            <div class="worker-stats">
                                <div class="stat-item">
                                    <div class="stat-value">${totalDays}</div>
                                    <div class="stat-label">Total Days</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${totalOT.toFixed(1)}h</div>
                                    <div class="stat-label">Total OT</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${totalManhours.toFixed(1)}h</div>
                                    <div class="stat-label">Total Hours</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${avgHours.toFixed(1)}h</div>
                                    <div class="stat-label">Avg Hours/Day</div>
                                </div>
                            </div>
                        </div>
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="month-nav">
                                    <button class="nav-btn" onclick="dashboard.changeMonth(-1)">‚Äπ</button>
                                    <div class="month-year" id="monthYear"></div>
                                    <button class="nav-btn" onclick="dashboard.changeMonth(1)">‚Ä∫</button>
                                </div>
                            </div>
                            <div class="calendar-grid" id="calendarGrid"></div>
                        </div>
                    </div>
                `;

                this.renderCalendar();
            }

            changeMonth(direction) {
                this.currentDate.setMonth(this.currentDate.getMonth() + direction);
                this.renderCalendar();
            }

            renderCalendar() {
                const monthYear = document.getElementById('monthYear');
                const calendarGrid = document.getElementById('calendarGrid');
                
                if (!monthYear || !calendarGrid) return;

                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                monthYear.textContent = new Date(year, month).toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });

                // Get calendar data
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();

                // Get previous month days
                const prevMonth = new Date(year, month - 1, 0);
                const daysInPrevMonth = prevMonth.getDate();

                let calendarHTML = `
                    <div class="calendar-header-cell">Sun</div>
                    <div class="calendar-header-cell">Mon</div>
                    <div class="calendar-header-cell">Tue</div>
                    <div class="calendar-header-cell">Wed</div>
                    <div class="calendar-header-cell">Thu</div>
                    <div class="calendar-header-cell">Fri</div>
                    <div class="calendar-header-cell">Sat</div>
                `;

                // Previous month days
                for (let i = startDayOfWeek - 1; i >= 0; i--) {
                    const day = daysInPrevMonth - i;
                    calendarHTML += `
                        <div class="calendar-cell other-month">
                            <div class="date-number">${day}</div>
                        </div>
                    `;
                }

                // Current month days
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDay = new Date(year, month, day);
                    const isToday = currentDay.toDateString() === today.toDateString();
                    
                    const attendanceRecord = this.getAttendanceForDate(currentDay);
                    let attendanceBadge = '';
                    
                    if (attendanceRecord) {
                        // If worker has any record for this date, mark as present
                        const endShift = attendanceRecord.endShiftHours;
                        if (endShift && endShift >= 12) {
                            const otHours = Math.floor(endShift - 8);
                            attendanceBadge = `<div class="attendance-badge present">P${otHours}</div>`;
                        } else if (endShift && endShift > 0) {
                            // Worker is present - any end shift number means present
                            attendanceBadge = `<div class="attendance-badge present">P</div>`;
                        } else {
                            // Worker has record but no end shift hours - still present
                            attendanceBadge = `<div class="attendance-badge present">P</div>`;
                        }
                    }

                    calendarHTML += `
                        <div class="calendar-cell ${isToday ? 'today' : ''}">
                            <div class="date-number">${day}</div>
                            ${attendanceBadge}
                        </div>
                    `;
                }

                // Next month days
                const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
                const nextMonthDays = totalCells - (startDayOfWeek + daysInMonth);
                
                for (let day = 1; day <= nextMonthDays; day++) {
                    calendarHTML += `
                        <div class="calendar-cell other-month">
                            <div class="date-number">${day}</div>
                        </div>
                    `;
                }

                calendarGrid.innerHTML = calendarHTML;
            }

            getAttendanceForDate(date) {
                if (!this.currentWorker) return null;
                
                return this.attendanceData.find(record => 
                    record.workerName === this.currentWorker && 
                    record.date && 
                    record.date.toDateString() === date.toDateString()
                );
            }

            showError(message) {
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <h3>Error</h3>
                        <p>${message}</p>
                        <button onclick="dashboard.init()" style="margin-top: 15px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // Initialize dashboard
        let dashboard;
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AttendanceDashboard();
        });
    </script>
</body>
</html>
