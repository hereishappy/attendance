<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            border-radius: 4px;
            position: relative;
        }
        
        .present-day {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .overtime-day {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .absent-day {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .loading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .report-canvas {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Employee Attendance</h1>
            <p class="text-gray-600">Track your attendance and generate reports</p>
        </div>

        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Employee Name</label>
                <input 
                    type="text" 
                    id="employeeName" 
                    placeholder="Enter your full name"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
            </div>
            <button 
                onclick="searchEmployee()" 
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200"
            >
                Search Attendance
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="text-center">
                <div class="loading w-8 h-8 bg-blue-600 rounded-full mx-auto mb-3"></div>
                <p class="text-gray-600">Fetching attendance data...</p>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="summarySection" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Attendance Summary</h2>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalPresent">0</div>
                    <div class="text-sm text-green-700">Present Days</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-orange-600" id="totalOvertime">0</div>
                    <div class="text-sm text-orange-700">OT Hours</div>
                </div>
            </div>
            
            <!-- Calendar View -->
            <div class="mb-4">
                <h3 class="font-medium text-gray-700 mb-3">Monthly Calendar</h3>
                <div class="calendar-grid mb-2" id="calendarHeader">
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Sun</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Mon</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Tue</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Wed</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Thu</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Fri</div>
                    <div class="text-xs font-medium text-gray-500 text-center py-2">Sat</div>
                </div>
                <div class="calendar-grid" id="calendarDays"></div>
            </div>

            <!-- Legend -->
            <div class="flex justify-center space-x-4 text-xs mb-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded mr-1"></div>
                    <span>Present</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-orange-500 rounded mr-1"></div>
                    <span>Overtime</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-300 rounded mr-1"></div>
                    <span>Absent</span>
                </div>
            </div>

            <button 
                onclick="generateReport()" 
                class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 mb-3"
            >
                Download Report (JPEG)
            </button>
        </div>

        <!-- Instructions -->
        <div id="instructionsSection" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
            <p class="text-sm text-yellow-800 mb-3">
                यदि आपको कोई अनुपस्थित या ओवरटाइम छूट गया है, तो कृपया अपने पर्यवेक्षक को सूचित करें।
            </p>
            <button 
                onclick="fileGrievance()" 
                class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200"
            >
                File Grievance
            </button>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
            <p class="text-sm text-red-800"></p>
        </div>
    </div>

    <!-- Hidden Canvas for Report Generation -->
    <canvas id="reportCanvas" style="display: none;"></canvas>

    <script>
        let attendanceData = [];
        let currentEmployeeData = [];

        async function fetchAttendanceData() {
            try {
                const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRxODcmDFDJLfScffQaei0ejYlolvQKi32KiWBBAp97WO7lLuD1TZHgK-ibCMn5kmW_0CsQHZMzcrHp/pub?gid=1727336003&single=true&output=csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                attendanceData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header] = values[index] || '';
                        });
                        attendanceData.push(record);
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error fetching data:', error);
                return false;
            }
        }

        async function searchEmployee() {
            const employeeName = document.getElementById('employeeName').value.trim();
            
            if (!employeeName) {
                showError('Please enter your name');
                return;
            }

            showLoading(true);
            hideError();

            const dataFetched = await fetchAttendanceData();
            
            if (!dataFetched) {
                showLoading(false);
                showError('Unable to fetch attendance data. Please try again.');
                return;
            }

            // Filter data for the employee
            currentEmployeeData = attendanceData.filter(record => 
                record['EMP NAME'] && record['EMP NAME'].toLowerCase().includes(employeeName.toLowerCase())
            );

            showLoading(false);

            if (currentEmployeeData.length === 0) {
                showError('No attendance records found for this employee name');
                return;
            }

            displaySummary();
        }

        function displaySummary() {
            let totalPresent = 0;
            let totalOvertime = 0;
            const attendanceDays = {};

            currentEmployeeData.forEach(record => {
                const date = record['Date'];
                const shiftHours = parseFloat(record['Shift Hours']) || 0;
                const otHours = parseFloat(record['OT HOURS']) || 0;

                if (shiftHours > 0) {
                    totalPresent++;
                    attendanceDays[date] = {
                        present: true,
                        overtime: otHours > 0,
                        otHours: otHours
                    };
                }
                
                totalOvertime += otHours;
            });

            document.getElementById('totalPresent').textContent = totalPresent;
            document.getElementById('totalOvertime').textContent = totalOvertime.toFixed(1);

            generateCalendar(attendanceDays);
            
            document.getElementById('summarySection').classList.remove('hidden');
            document.getElementById('instructionsSection').classList.remove('hidden');
        }

        function generateCalendar(attendanceDays) {
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            // Get current month for demo (you can modify this to show specific months)
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            for (let i = 0; i < 42; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const dayNumber = document.createElement('div');
                dayNumber.textContent = currentDate.getDate();
                dayElement.appendChild(dayNumber);

                if (currentDate.getMonth() === month) {
                    if (attendanceDays[dateStr]) {
                        if (attendanceDays[dateStr].overtime) {
                            dayElement.classList.add('overtime-day');
                            const otLabel = document.createElement('div');
                            otLabel.textContent = 'OT';
                            otLabel.className = 'text-xs';
                            dayElement.appendChild(otLabel);
                        } else if (attendanceDays[dateStr].present) {
                            dayElement.classList.add('present-day');
                        }
                    } else {
                        dayElement.classList.add('absent-day');
                    }
                } else {
                    dayElement.classList.add('absent-day');
                    dayElement.style.opacity = '0.3';
                }

                calendarDays.appendChild(dayElement);
            }
        }

        function generateReport() {
            const canvas = document.getElementById('reportCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set high resolution for better quality
            canvas.width = 1200;
            canvas.height = 1600;
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Header
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 48px Inter, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Attendance Summary Report', canvas.width / 2, 80);
            
            // Employee name
            const employeeName = document.getElementById('employeeName').value;
            ctx.font = '32px Inter, Arial, sans-serif';
            ctx.fillText(`Employee: ${employeeName}`, canvas.width / 2, 140);
            
            // Date range
            ctx.font = '24px Inter, Arial, sans-serif';
            ctx.fillStyle = '#6b7280';
            const today = new Date();
            ctx.fillText(`Report Generated: ${today.toLocaleDateString()}`, canvas.width / 2, 180);
            
            // Summary boxes
            const totalPresent = document.getElementById('totalPresent').textContent;
            const totalOvertime = document.getElementById('totalOvertime').textContent;
            
            // Present days box
            ctx.fillStyle = '#10b981';
            ctx.fillRect(150, 220, 400, 120);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 36px Inter, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Present Days', 350, 260);
            ctx.font = 'bold 48px Inter, Arial, sans-serif';
            ctx.fillText(totalPresent, 350, 310);
            
            // Overtime box
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(650, 220, 400, 120);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 36px Inter, Arial, sans-serif';
            ctx.fillText('Overtime Hours', 850, 260);
            ctx.font = 'bold 48px Inter, Arial, sans-serif';
            ctx.fillText(totalOvertime, 850, 310);
            
            // Table header
            let yPos = 400;
            ctx.fillStyle = '#374151';
            ctx.fillRect(100, yPos, 1000, 60);
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Inter, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Date', 120, yPos + 35);
            ctx.fillText('Supervisor', 300, yPos + 35);
            ctx.fillText('Shift Hours', 550, yPos + 35);
            ctx.fillText('OT Hours', 750, yPos + 35);
            ctx.fillText('Status', 950, yPos + 35);
            
            // Table rows
            yPos += 60;
            ctx.font = '20px Inter, Arial, sans-serif';
            
            currentEmployeeData.slice(0, 25).forEach((record, index) => {
                const rowColor = index % 2 === 0 ? '#f9fafb' : '#ffffff';
                ctx.fillStyle = rowColor;
                ctx.fillRect(100, yPos, 1000, 40);
                
                ctx.fillStyle = '#374151';
                ctx.fillText(record['Date'] || '', 120, yPos + 25);
                ctx.fillText(record['Supervisor'] || '', 300, yPos + 25);
                ctx.fillText(record['Shift Hours'] || '0', 550, yPos + 25);
                ctx.fillText(record['OT HOURS'] || '0', 750, yPos + 25);
                
                const shiftHours = parseFloat(record['Shift Hours']) || 0;
                const status = shiftHours > 0 ? 'Present' : 'Absent';
                ctx.fillStyle = shiftHours > 0 ? '#10b981' : '#ef4444';
                ctx.fillText(status, 950, yPos + 25);
                
                yPos += 40;
            });
            
            // Instructions in Hindi
            yPos += 60;
            ctx.fillStyle = '#dc2626';
            ctx.font = '24px Inter, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('यदि आपको कोई अनुपस्थित या ओवरटाइम छूट गया है,', canvas.width / 2, yPos);
            ctx.fillText('तो कृपया अपने पर्यवेक्षक को सूचित करें।', canvas.width / 2, yPos + 40);
            
            // Download the image
            const link = document.createElement('a');
            link.download = `attendance_report_${employeeName}_${today.toISOString().split('T')[0]}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            link.click();
        }

        function fileGrievance() {
            const employeeName = document.getElementById('employeeName').value;
            const message = `Grievance Report from ${employeeName}%0A%0ARegarding: Attendance/Overtime Discrepancy%0A%0APlease describe your issue here...`;
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function showLoading(show) {
            const loadingState = document.getElementById('loadingState');
            if (show) {
                loadingState.classList.remove('hidden');
            } else {
                loadingState.classList.add('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'974a0c4d542085fa',t:'MTc1NjExMzk4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
