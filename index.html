<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Live Google Sheet Dashboard</title>
    <!-- React + ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <style>
      /* Minimal clean styles (Tailwind-like feel without dependency) */
      :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#60a5fa}
      html,body,#root{height:100%;margin:0;background:linear-gradient(180deg,#071024 0%, #071526 100%);color:#e6eef8;font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
      .container{max-width:1100px;margin:24px auto;padding:16px}
      .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
      .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
      .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
      .kpi{padding:18px;border-radius:10px}
      .table{width:100%;border-collapse:collapse;margin-top:12px}
      table th,table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
      .small{font-size:12px;color:var(--muted)}
      .btn{background:linear-gradient(90deg,var(--accent),#3b82f6);padding:8px 12px;border-radius:8px;color:#04263b;font-weight:600;border:none;cursor:pointer}
      @media(max-width:900px){.grid{grid-template-columns:repeat(1,1fr)} }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const { useState, useEffect, useRef } = React;

      // === CONFIG ===
      // Replace with your published CSV URL
      const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTRmYg3zmYTdR76pDZirRk3Q-jGChOHtKwW5sRhi9NmaOWjCCvMeGi_CzmtbEVRrVt_u4mgTQmyrjYB/pub?output=csv';
      const POLL_SECONDS = 30; // fetch interval
      // ==============

      function useInterval(callback, delay) {
        const savedRef = useRef();
        useEffect(() => { savedRef.current = callback; }, [callback]);
        useEffect(() => {
          if (delay == null) return;
          const id = setInterval(() => savedRef.current(), delay);
          return () => clearInterval(id);
        }, [delay]);
      }

      function parseCsvText(text) {
        // Use PapaParse to parse and return array of objects if header present
        const parsed = Papa.parse(text.trim(), { header: true, skipEmptyLines: true });
        return parsed.data;
      }

      function numberify(v) {
        if (v === undefined || v === null || v === '') return null;
        // remove commas, percent signs
        const cleaned = String(v).replace(/,/g,'').replace(/%/g,'').trim();
        if (!isNaN(cleaned) && cleaned !== '') return Number(cleaned);
        return null;
      }

      function KPI({label, value, small}){
        return (
          React.createElement('div', {className:'card kpi'},
            React.createElement('div', {className:'small'}, label),
            React.createElement('div', {style:{fontSize:28, fontWeight:700, marginTop:8}}, value),
            small ? React.createElement('div',{className:'small', style:{marginTop:6}}, small) : null
          )
        );
      }

      function TableView({data}){
        if (!data || data.length === 0) return React.createElement('div', null, 'No data');
        const keys = Object.keys(data[0]);
        return (
          React.createElement('div', null,
            React.createElement('table', {className:'table card'},
              React.createElement('thead', null,
                React.createElement('tr', null, keys.map(k=>React.createElement('th',{key:k},k)))
              ),
              React.createElement('tbody', null,
                data.map((row,i)=>React.createElement('tr',{key:i}, keys.map(k=>React.createElement('td',{key:k}, row[k]))))
              )
            )
          )
        );
      }

      function Chart({id, type, labels, datasets}){
        const ref = useRef();
        useEffect(()=>{
          if (!labels) return;
          const ctx = ref.current.getContext('2d');
          let chart = new ChartJS.Chart(ctx, { type, data: { labels, datasets }, options: { responsive:true, maintainAspectRatio:false } });
          return ()=>{ chart.destroy(); };
        }, [labels?.length]);
        return React.createElement('div', {className:'card', style:{height:240, padding:10}}, React.createElement('canvas',{ref:ref,id:id}));
      }

      function App(){
        const [data, setData] = useState([]);
        const [lastUpdated, setLastUpdated] = useState(null);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);

        async function fetchCsv(){
          try{
            setLoading(true); setError(null);
            const r = await fetch(CSV_URL + '&_=' + Date.now());
            if (!r.ok) throw new Error('Failed to fetch CSV: ' + r.status);
            const text = await r.text();
            const parsed = parseCsvText(text);
            setData(parsed);
            setLastUpdated(new Date().toLocaleString());
          }catch(e){
            console.error(e); setError(String(e));
          }finally{ setLoading(false); }
        }

        useEffect(()=>{ fetchCsv(); }, []);
        useInterval(()=>{ fetchCsv(); }, POLL_SECONDS * 1000);

        // Compute some simple KPIs from numeric columns
        const numericCols = {};
        data.forEach(row=>{
          Object.entries(row).forEach(([k,v])=>{
            const n = numberify(v);
            if (n !== null) {
              if (!numericCols[k]) numericCols[k] = [];
              numericCols[k].push(n);
            }
          });
        });

        // Choose first numeric column as example time-series (if it looks like date? we won't assume)
        const numericKeys = Object.keys(numericCols);
        const kpiElements = numericKeys.slice(0,3).map(k=>{
          const arr = numericCols[k];
          const sum = arr.reduce((a,b)=>a+b,0);
          const avg = (arr.length>0)?(sum/arr.length).toFixed(2):'—';
          const max = (arr.length>0)?Math.max(...arr):'—';
          return React.createElement(KPI,{key:k,label:k,value:avg,small:`avg • count ${arr.length} • max ${max}`});
        });

        // Prepare chart data: if data has a first column that's likely a date or label
        let labels = [];
        let chartDataset = null;
        if (data.length>0){
          const keys = Object.keys(data[0]);
          const firstNumericKey = numericKeys[0];
          labels = data.map((r,i)=> r[keys[0]] || i+1 );
          if (firstNumericKey) chartDataset = data.map(r=> numberify(r[firstNumericKey]) ?? 0);
        }

        return (
          React.createElement('div', {className:'container'},
            React.createElement('div',{className:'header'},
              React.createElement('div',null, React.createElement('h2',null,'Live Dashboard — Google Sheet CSV (client-side)'), React.createElement('div',{className:'small'}, 'Auto-updates every ' + POLL_SECONDS + 's')),
              React.createElement('div',null,
                React.createElement('button',{className:'btn', onClick: fetchCsv}, 'Refresh now')
              )
            ),

            React.createElement('div',{className:'grid', style:{marginBottom:12}},
              kpiElements.length? kpiElements : React.createElement('div', {className:'card kpi'}, 'No numeric columns found')
            ),

            React.createElement('div', {className:'grid'},
              React.createElement('div', {style:{gridColumn:'span 2'}},
                React.createElement('div',{className:'card'},
                  React.createElement('h3', null, 'Data table'),
                  loading ? React.createElement('div', null, 'Loading...') : error ? React.createElement('div', {style:{color:'tomato'}}, error) : React.createElement(TableView, {data})
                )
              ),

              React.createElement('div', null,
                React.createElement('div',{className:'card'},
                  React.createElement('h3', null, 'Charts & summary'),
                  React.createElement('div', {style:{height:260}},
                    chartDataset ? React.createElement(Chart, {id:'chart1', type:'line', labels:labels, datasets:[{label:numericKeys[0], data:chartDataset, fill:false, tension:0.3}]}) : React.createElement('div', null, 'No chartable numeric column')
                  ),
                  React.createElement('div',{className:'small', style:{marginTop:8}}, 'Last updated: ' + (lastUpdated || '—'))
                )
              )
            )

          )
        );
      }

      // Mount
      ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
  </body>
</html>
